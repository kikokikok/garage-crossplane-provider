# Architecture

This document describes the architecture of provider-garage, a native Crossplane provider for Garage object storage.

## Overview

provider-garage is built using [Upjet](https://github.com/crossplane/upjet), which generates Crossplane Managed Resources (MRs) from Terraform providers. This approach combines the maturity of Terraform providers with the cloud-native patterns of Crossplane.

## Components

### 1. Provider Controller

The provider controller (`cmd/provider/main.go`) is the main entry point that:
- Initializes the Kubernetes controller manager
- Registers all resource controllers
- Manages the provider lifecycle
- Handles leader election for high availability

### 2. Resource Controllers

Generated by Upjet, these controllers reconcile Kubernetes resources with Garage API state:

- **Bucket Controller**: Manages Garage S3 buckets
- **Key Controller**: Manages Garage access keys
- **KeyAccess Controller**: Manages bucket permissions for keys

Each controller:
- Watches its respective Custom Resource Definition (CRD)
- Reconciles desired state (Kubernetes) with actual state (Garage)
- Updates resource status with current state
- Manages connection secrets for credentials

### 3. Configuration Layer

Located in `config/`, this layer defines:

#### External Names (`config/external_name.go`)
Maps Crossplane resource names to Garage resource identifiers.

#### Resource Configurations
- `config/bucket/config.go`: Bucket resource configuration
- `config/key/config.go`: Key and KeyAccess resource configuration

Each configuration specifies:
- API group and kind
- Field mappings
- Reference relationships
- Sensitive data handling

#### Provider Configuration (`config/provider.go`)
Central configuration that:
- Registers all resources
- Configures code generation
- Sets up provider defaults

### 4. Client Layer

The client layer (`internal/clients/garage.go`) handles:
- Authentication with Garage Admin API
- Credential extraction from Kubernetes secrets
- Terraform provider setup
- Provider configuration management

### 5. API Types

Located in `apis/`, these define the Kubernetes API:

#### Core APIs (`apis/v1beta1/`)
- `ProviderConfig`: Cluster-scoped configuration resource
- `ProviderConfigUsage`: Tracks which resources use which configs

#### Resource APIs (generated by Upjet)
- `apis/bucket/v1alpha1/`: Bucket resource types
- `apis/key/v1alpha1/`: Key and KeyAccess resource types

## Data Flow

### Resource Creation Flow

```
1. User creates Bucket resource in Kubernetes
   ↓
2. Bucket controller detects new resource
   ↓
3. Controller extracts credentials from ProviderConfig
   ↓
4. Client layer configures Terraform provider
   ↓
5. Upjet executes terraform plan
   ↓
6. Upjet executes terraform apply
   ↓
7. Garage Admin API creates bucket
   ↓
8. Controller updates resource status
   ↓
9. Connection secret created (if configured)
```

### Reconciliation Loop

Controllers continuously reconcile state:

```
┌─────────────────────────────────────┐
│   Kubernetes Desired State          │
│   (Custom Resources)                │
└──────────────┬──────────────────────┘
               │
               │ Reconcile
               ↓
┌─────────────────────────────────────┐
│   Controller Reconciliation         │
│   - Compare desired vs actual       │
│   - Generate Terraform plan         │
│   - Apply changes if needed         │
└──────────────┬──────────────────────┘
               │
               │ Terraform operations
               ↓
┌─────────────────────────────────────┐
│   Garage Admin API                  │
│   (Actual State)                    │
└─────────────────────────────────────┘
```

## Security Model

### Credential Management

1. **ProviderConfig Credentials**:
   - Stored in Kubernetes Secret
   - Referenced by ProviderConfig
   - Used for Garage Admin API authentication
   - Should be stored in `crossplane-system` namespace

2. **Connection Secrets**:
   - Generated by controllers
   - Contain resource-specific credentials (e.g., S3 keys)
   - Stored in the same namespace as the resource
   - Can be referenced by application pods

### RBAC

The provider requires:
- Read access to ProviderConfig resources
- Read access to credential Secrets
- Full access to managed resources (Bucket, Key, KeyAccess)
- Write access to connection Secrets

## Crossplane v2 Compatibility

### Namespaced Resources

All managed resources are namespaced, following Crossplane v2 patterns:

```
Namespace: my-app
├── Bucket: my-bucket
├── Key: my-key
├── KeyAccess: my-access
└── Secret: my-credentials
```

### Composition Support

Resources can be composed into higher-level abstractions:

```
XRD (Namespaced)
  ├── Composition
  │   ├── Bucket (namespaced MR)
  │   ├── Key (namespaced MR)
  │   └── KeyAccess (namespaced MR)
  └── Connection Secret (in XR namespace)
```

## Resource Relationships

### Reference Graph

```
KeyAccess
  ├── keyIdRef → Key
  └── bucketIdRef → Bucket

Key
  └── writeConnectionSecretToRef → Secret

Bucket
  └── providerConfigRef → ProviderConfig

ProviderConfig
  └── secretRef → Secret (credentials)
```

### Dependency Management

Controllers handle dependencies automatically:
1. KeyAccess waits for Key and Bucket to be ready
2. Resources wait for ProviderConfig to be available
3. Deletion respects dependency order (KeyAccess → Key/Bucket)

## State Management

### Terraform State

Upjet uses Terraform for state management:
- Each resource has its own Terraform workspace
- State is stored in Kubernetes (as part of resource status)
- No external state backend required
- Automatic state locking via Kubernetes optimistic concurrency

### Resource Status

Resource status contains:
- `Ready` condition: Indicates if resource is ready
- `Synced` condition: Indicates if last reconciliation succeeded
- External name: Garage resource identifier
- Terraform state: Current Terraform workspace state

## Performance Considerations

### Reconciliation

- **Poll Interval**: Default 1 minute
- **Sync Interval**: Default 1 hour
- **Terraform Operations**: Each reconciliation runs terraform plan/apply
- **Resource Intensity**: Suitable for <100 resources per provider instance

### Scaling

For large-scale deployments:
- Run multiple provider pods with leader election
- Increase max reconcile rate
- Consider resource quotas per namespace
- Monitor provider resource usage

## Error Handling

### Retry Strategy

Controllers implement exponential backoff:
1. Immediate retry on transient errors
2. Exponential backoff (up to 1 hour)
3. Permanent errors marked in status

### Failure Scenarios

| Scenario | Behavior |
|----------|----------|
| Garage API unavailable | Retry with backoff |
| Invalid credentials | Mark as failed, stop retrying |
| Resource conflict | Retry with backoff |
| Terraform error | Log error, retry with backoff |

## Monitoring and Observability

### Metrics

The provider exposes Prometheus metrics:
- Controller reconciliation rate
- Reconciliation errors
- Resource counts by type
- Terraform operation duration

### Logging

Structured logging with levels:
- **Debug**: Detailed operation logs
- **Info**: Normal operations
- **Error**: Failures and errors

### Health Checks

- Kubernetes liveness probe: Provider process health
- Kubernetes readiness probe: Controller manager ready

## Development Workflow

### Code Generation

When Garage Terraform provider updates:

```bash
# 1. Update provider version in config
# 2. Regenerate code
make generate

# 3. Verify generated CRDs
ls apis/*/v1alpha1/

# 4. Test compilation
make build

# 5. Run tests
make test
```

### Adding New Resources

To add a new Garage resource:

1. Add resource to external name config
2. Create resource configurator in `config/`
3. Register in `config/provider.go`
4. Generate code with `make generate`
5. Test the new resource

## Future Enhancements

### Planned Features

1. **Native API Client**: Replace Terraform with direct API calls
2. **Advanced Compositions**: Pre-built XRDs for common patterns
3. **Observability**: Better metrics and tracing
4. **Performance**: Optimize reconciliation loops
5. **Testing**: Comprehensive integration tests

### Community Contributions

Areas for contribution:
- Documentation improvements
- Example compositions
- Bug fixes
- Performance optimizations
- Additional Garage resources

## References

- [Crossplane Architecture](https://docs.crossplane.io/latest/concepts/architecture/)
- [Upjet Documentation](https://github.com/crossplane/upjet)
- [Garage API Documentation](https://garagehq.deuxfleurs.fr/)
- [Kubernetes Controller Pattern](https://kubernetes.io/docs/concepts/architecture/controller/)
