name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Build binary
        run: make build

      - name: Verify binary
        run: |
          if [ ! -f bin/provider ]; then
            echo "Binary not found!"
            exit 1
          fi
          file bin/provider
          ls -lh bin/provider

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Kind
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: test-cluster
          wait: 120s

      - name: Install Crossplane
        run: |
          helm repo add crossplane-stable https://charts.crossplane.io/stable
          helm repo update
          helm install crossplane crossplane-stable/crossplane \
            --namespace crossplane-system \
            --create-namespace \
            --wait

      - name: Wait for Crossplane to be ready
        run: |
          kubectl wait --for=condition=available --timeout=300s \
            deployment/crossplane -n crossplane-system
          kubectl get pods -n crossplane-system

      - name: Build and load provider image
        run: |
          make docker-build IMG=provider-garage:test
          kind load docker-image provider-garage:test --name test-cluster

      - name: Generate and apply CRDs
        run: |
          make generate-crds
          kubectl apply -f package/crds/

      - name: Deploy Garage for integration testing
        run: |
          # Create namespace for Garage
          kubectl create namespace garage-system

          # Create Garage configuration
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: garage-config
            namespace: garage-system
          data:
            garage.toml: |
              metadata_dir = "/data/meta"
              data_dir = "/data/data"
              db_engine = "sqlite"
              replication_factor = 1
              
              [rpc]
              bind_addr = "[::]:3901"
              secret = "$(openssl rand -hex 32)"
              
              [s3_api]
              s3_region = "garage"
              api_bind_addr = "[::]:3900"
              root_domain = ".s3.garage.localhost"
              
              [s3_web]
              bind_addr = "[::]:3902"
              root_domain = ".web.garage.localhost"
              
              [admin]
              api_bind_addr = "[::]:3903"
              admin_token = "test-admin-token"
          EOF

          # Deploy Garage StatefulSet
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: garage
            namespace: garage-system
          spec:
            serviceName: garage
            replicas: 1
            selector:
              matchLabels:
                app: garage
            template:
              metadata:
                labels:
                  app: garage
              spec:
                containers:
                - name: garage
                  image: dxflrs/garage:v1.0.1
                  ports:
                  - containerPort: 3900
                    name: s3
                  - containerPort: 3901
                    name: rpc
                  - containerPort: 3902
                    name: web
                  - containerPort: 3903
                    name: admin
                  volumeMounts:
                  - name: config
                    mountPath: /etc/garage.toml
                    subPath: garage.toml
                  - name: data
                    mountPath: /data
                volumes:
                - name: config
                  configMap:
                    name: garage-config
                - name: data
                  emptyDir: {}
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: garage
            namespace: garage-system
          spec:
            selector:
              app: garage
            ports:
            - name: s3
              port: 3900
              targetPort: 3900
            - name: rpc
              port: 3901
              targetPort: 3901
            - name: web
              port: 3902
              targetPort: 3902
            - name: admin
              port: 3903
              targetPort: 3903
          EOF

          # Wait for Garage to be ready
          kubectl rollout status statefulset/garage -n garage-system --timeout=120s

          # Configure Garage cluster layout
          kubectl exec -n garage-system garage-0 -- /garage layout assign -z dc1 -c 1G \$(kubectl exec -n garage-system garage-0 -- /garage node id -q | cut -d@ -f1)
          kubectl exec -n garage-system garage-0 -- /garage layout apply --version 1

      - name: Create ProviderConfig for Garage
        run: |
          # Create secret with Garage credentials
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: garage-creds
            namespace: crossplane-system
          type: Opaque
          stringData:
            credentials: |
              {
                "endpoint": "http://garage.garage-system.svc.cluster.local:3903",
                "adminToken": "test-admin-token"
              }
          EOF

          # Create ProviderConfig
          cat <<EOF | kubectl apply -f -
          apiVersion: garage.crossplane.io/v1beta1
          kind: ProviderConfig
          metadata:
            name: default
          spec:
            credentials:
              source: Secret
              secretRef:
                name: garage-creds
                namespace: crossplane-system
                key: credentials
          EOF

      - name: Deploy provider in cluster
        run: |
          # Create service account and RBAC for the provider
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: provider-garage
            namespace: crossplane-system
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRole
          metadata:
            name: provider-garage
          rules:
          - apiGroups:
            - garage.crossplane.io
            resources:
            - "*"
            verbs:
            - "*"
          - apiGroups:
            - ""
            resources:
            - secrets
            verbs:
            - get
            - list
            - watch
          - apiGroups:
            - ""
            resources:
            - events
            verbs:
            - create
            - patch
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: provider-garage
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: provider-garage
          subjects:
          - kind: ServiceAccount
            name: provider-garage
            namespace: crossplane-system
          EOF

          # Create provider deployment
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: provider-garage
            namespace: crossplane-system
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: provider-garage
            template:
              metadata:
                labels:
                  app: provider-garage
              spec:
                serviceAccountName: provider-garage
                containers:
                - name: provider
                  image: provider-garage:test
                  imagePullPolicy: Never
                  args:
                  - --debug
          EOF

          # Wait for provider to be ready
          kubectl rollout status deployment/provider-garage -n crossplane-system --timeout=120s
          echo "Provider is running!"
          kubectl logs -n crossplane-system -l app=provider-garage --tail=50

      - name: Test bucket provisioning
        run: |
          # Create a test bucket
          cat <<EOF | kubectl apply -f -
          apiVersion: garage.crossplane.io/v1alpha1
          kind: Bucket
          metadata:
            name: test-bucket
            namespace: default
          spec:
            forProvider:
              globalAlias: integration-test-bucket
            providerConfigRef:
              name: default
          EOF

          # Wait for bucket to be created (with retries)
          echo "Waiting for bucket to be provisioned..."
          for i in {1..30}; do
            STATUS=$(kubectl get bucket test-bucket -n default -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "Unknown")
            SYNCED=$(kubectl get bucket test-bucket -n default -o jsonpath='{.status.conditions[?(@.type=="Synced")].status}' 2>/dev/null || echo "Unknown")
            echo "Attempt $i: Ready=$STATUS, Synced=$SYNCED"
            
            if [ "$STATUS" = "True" ] && [ "$SYNCED" = "True" ]; then
              echo "Bucket provisioned successfully!"
              kubectl get bucket test-bucket -n default -o yaml
              exit 0
            fi
            
            # Show provider logs if not ready
            if [ $i -eq 15 ] || [ $i -eq 25 ]; then
              echo "--- Provider logs ---"
              kubectl logs -n crossplane-system -l app=provider-garage --tail=30
            fi
            
            sleep 5
          done
          
          echo "Bucket provisioning timed out"
          echo "--- Final bucket status ---"
          kubectl get bucket test-bucket -n default -o yaml
          echo "--- Provider logs ---"
          kubectl logs -n crossplane-system -l app=provider-garage --tail=100
          exit 1

      - name: Cleanup test resources
        if: always()
        run: |
          kubectl delete bucket test-bucket -n default --ignore-not-found=true
          echo "Test resources cleaned up"
