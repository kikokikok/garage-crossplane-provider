name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Initialize submodules
        run: |
          git submodule sync
          git submodule update --init --recursive

      - name: Build binaries
        run: |
          mkdir -p bin
          # Build for multiple platforms
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/provider-garage-linux-amd64 ./cmd/provider
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o bin/provider-garage-linux-arm64 ./cmd/provider
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o bin/provider-garage-darwin-amd64 ./cmd/provider
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -o bin/provider-garage-darwin-arm64 ./cmd/provider

      - name: Generate CRDs
        run: |
          mkdir -p package/crds
          go run sigs.k8s.io/controller-tools/cmd/controller-gen \
            crd:crdVersions=v1 \
            paths="./apis/..." \
            output:crd:artifacts:config=package/crds

      - name: Update Crossplane package metadata image
        run: |
          # Update the image reference in the existing crossplane.yaml using sed
          # Pattern matches the full image URL to avoid unintended replacements
          sed -i "s|image: ghcr.io/kikokikok/garage-crossplane-provider:.*|image: ${REGISTRY}/${IMAGE_NAME}:${{ steps.get_version.outputs.VERSION }}|" package/crossplane.yaml

      - name: Log in to Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          file: Dockerfile

      - name: Pull Docker image for xpkg embedding
        run: |
          # Pull the image we just pushed so it's available locally for xpkg build
          # Use the version from docker metadata which strips the 'v' prefix
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

      - name: Install Crossplane CLI
        run: |
          # Install Crossplane CLI for xpkg build with --embed-runtime-image
          curl -sL https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh | sh
          sudo mv crossplane /usr/local/bin/
          crossplane version || echo "Crossplane CLI installed"

      - name: Create Crossplane package
        run: |
          # Build the package using Crossplane CLI with embedded controller image
          # The --embed-runtime-image flag embeds the controller image into the xpkg
          crossplane xpkg build \
            --package-root=package \
            --embed-runtime-image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
            --package-file=package/provider-garage-${{ steps.get_version.outputs.VERSION }}.xpkg

      - name: Verify xpkg and move to repo root
        run: |
          set -euo pipefail
          XPkg="package/provider-garage-${{ steps.get_version.outputs.VERSION }}.xpkg"

          echo "Looking for xpkg at: $XPkg"
          if [ ! -f "$XPkg" ]; then
            echo "ERROR: xpkg not found: $XPkg" >&2
            echo "Working directory: $(pwd)" >&2
            echo "Listing package/ and repo root for debugging:" >&2
            ls -la package || true
            ls -la . || true
            exit 1
          fi

          mv "$XPkg" .
          echo "Moved $XPkg to $(pwd)/"

      - name: Upload xpkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: provider-xpkg
          path: provider-garage-${{ steps.get_version.outputs.VERSION }}.xpkg

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            bin/provider-garage-*
            provider-garage-${{ steps.get_version.outputs.VERSION }}.xpkg
          body: |
            ## Release ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            
            ```bash
            kubectl crossplane install provider ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.VERSION }}
            ```
            
            ### Binaries
            - Linux AMD64: `provider-garage-linux-amd64`
            - Linux ARM64: `provider-garage-linux-arm64`
            - Darwin AMD64: `provider-garage-darwin-amd64`
            - Darwin ARM64: `provider-garage-darwin-arm64`
            
            ### Crossplane Package
            - Crossplane package: `provider-garage-${{ steps.get_version.outputs.VERSION }}.xpkg`
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-upbound:
    name: Publish to Upbound Marketplace
    runs-on: ubuntu-latest
    needs: build-and-release
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version
        id: get_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          # VERSION_TAG keeps the v prefix for xpkg filenames
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          # DOCKER_TAG strips the v prefix for Docker image references
          echo "DOCKER_TAG=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Generate CRDs
        run: |
          mkdir -p package/crds
          go run sigs.k8s.io/controller-tools/cmd/controller-gen \
            crd:crdVersions=v1 \
            paths="./apis/..." \
            output:crd:artifacts:config=package/crds

      - name: Update Crossplane package metadata image for Upbound
        run: |
          # Update the image reference in the existing crossplane.yaml using sed
          # Pattern matches the full image URL to avoid unintended replacements
          sed -i "s|image: ghcr.io/kikokikok/garage-crossplane-provider:.*|image: ${REGISTRY}/${IMAGE_NAME}:${{ steps.get_version.outputs.VERSION }}|" package/crossplane.yaml

      - name: Install Crossplane CLI and UP CLI
        run: |
          # Install Crossplane CLI for xpkg build
          curl -sL https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh | sh
          sudo mv crossplane /usr/local/bin/
          crossplane version || echo "Crossplane CLI installed"
          
          # Install UP CLI for pushing to Upbound
          curl -sL https://cli.upbound.io | sh
          if [ -f up ]; then
            sudo mv up /usr/local/bin/
            sudo chmod +x /usr/local/bin/up
          else
            echo "ERROR: UP CLI binary not found after install" >&2
            ls -la
            exit 1
          fi

      - name: Login to Upbound
        env:
          UP_TOKEN: ${{ secrets.UPBOUND_TOKEN }}
        run: |
          # verify up binary exists and version
          up --version || true
          # show login help to detect supported flags
          up login --help || true

          # Login using the token directly (preferred)
          up login --token "${UP_TOKEN}"

      - name: Pull Docker image for xpkg embedding
        run: |
          # Pull the image so it's available locally for xpkg build
          # Docker image tags use DOCKER_TAG (without 'v' prefix)
          docker pull ghcr.io/kikokikok/garage-crossplane-provider:${{ steps.get_version.outputs.DOCKER_TAG }}

      - name: Build and push to Upbound
        env:
          UPBOUND_REPO: xpkg.upbound.io/${{ secrets.UPBOUND_ORG }}/provider-garage
          VERSION_TAG: ${{ steps.get_version.outputs.VERSION }}
          CONTROLLER_IMAGE: ghcr.io/kikokikok/garage-crossplane-provider:${{ steps.get_version.outputs.DOCKER_TAG }}
        run: |
          set -euo pipefail
          
          # Build the package with embedded controller image using Crossplane CLI
          crossplane xpkg build \
            --package-root=package \
            --embed-runtime-image=${CONTROLLER_IMAGE} \
            --package-file=package/provider-garage-${VERSION_TAG}.xpkg
          
          # Verify package exists
          XPkg="package/provider-garage-${VERSION_TAG}.xpkg"
          echo "Looking for xpkg at: $XPkg"
          
          if [ ! -f "$XPkg" ]; then
            echo "ERROR: xpkg not found: $XPkg" >&2
            echo "Working directory: $(pwd)" >&2
            echo "Listing package/ and repo root for debugging:" >&2
            ls -la package || true
            ls -la . || true
            exit 1
          fi
          
          mv "$XPkg" .
          echo "Moved $XPkg to $(pwd)/"
          
          # Push with version tag using UP CLI
          up xpkg push ${UPBOUND_REPO}:${VERSION_TAG} \
            -f provider-garage-${VERSION_TAG}.xpkg
          
          # Also push as latest if this is not a pre-release
          if [[ ! "${VERSION_TAG}" =~ (alpha|beta|rc) ]]; then
            up xpkg push ${UPBOUND_REPO}:latest \
              -f provider-garage-${VERSION_TAG}.xpkg
          fi
